---
---
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Registrar nuevo usuario</title>
  </head>
  <body>
    <h1>Registrar nuevo usuario</h1>

    <div id="loader" style="display: none;">
      <p>Cargando...</p>
    </div>

    <form id="form-usuario">
      <label for="nombre">Nombre:</label>
      <input type="text" id="nombre" name="nombre" required /><br />

      <label for="apellido">Apellido:</label>
      <input type="text" id="apellido" name="apellido" required /><br />

      <label for="email">Email:</label>
      <input type="email" id="email" name="email" required /><br />

      <label for="dni">DNI:</label>
      <input type="number" id="dni" name="dni" required /><br />

      <label for="password">Contrase√±a:</label>
      <input type="password" id="password" name="password" required /><br />

      <label for="rol">Rol:</label>
      <select id="rol_id" name="rol_id" required>
        <option value="">Seleccionar rol</option>
        <option value="1">Paciente</option>
        <option value="2">Profesional</option>
        <option value="3">Administrativo</option>
      </select><br />

      <button type="submit">Registrar</button>
    </form>

    <p id="mensaje" style="color: green; font-weight: bold;"></p>
    <a href="/admin"><button>Volver</button></a>

      <script type="module">
      const token = localStorage.getItem("token");
      const rol = localStorage.getItem("rol");
      const form = document.getElementById("form-usuario");
      const mensaje = document.getElementById("mensaje");
      const loader = document.getElementById("loader");

      if (!token || rol !== "administrativo") {
        alert("Acceso no autorizado");
        window.location.href = "/login";
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        mensaje.textContent = "";
        loader.style.display = "block";
        const submitBtn = form.querySelector("button[type='submit']");
        submitBtn.disabled = true;

        const nombre = document.getElementById("nombre").value;
        const apellido = document.getElementById("apellido").value;
        const email = document.getElementById("email").value;
        const dni = document.getElementById("dni").value;
        const password = document.getElementById("password").value;
        const rol_id = document.getElementById("rol_id").value;

        if (!nombre || !apellido || !email || !dni || !password || !rol_id) {
          mensaje.textContent = "Todos los campos son obligatorios.";
          mensaje.style.color = "red";
          ocultarMensaje();
          loader.style.display = "none";
          submitBtn.disabled = false;
          return;
        }

        try {
          const res = await fetch("http://localhost:3001/api/usuarios", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              nombre,
              apellido,
              email,
              password,
              dni,
              rol_id,
            }),
          });

          const data = await res.json();

          if (res.ok) {
            mensaje.textContent = data.mensaje || "Usuario registrado exitosamente.";
            mensaje.style.color = "green";
            form.reset();
          } else {
            mensaje.textContent = data.mensaje || "Error al registrar usuario.";
            mensaje.style.color = "red";
          }
        } catch (error) {
          console.error("Error al registrar usuario:", error);
          mensaje.textContent = "Error de red o del servidor.";
          mensaje.style.color = "red";
        } finally {
          ocultarMensaje();
          loader.style.display = "none";
          submitBtn.disabled = false;
        }
      });

      function ocultarMensaje() {
        setTimeout(() => {
          mensaje.textContent = "";
        }, 4000);
      }
  </script>

  </body>
</html>
